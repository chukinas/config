#!/bin/bash

. $COMOTO_CLI_LIB/print

_comoto_cli_command_summary='Set up your local database'
_comoto_cli_command_usage='comoto_cli db [OPTIONS] SETUP_COMMAND'

_comoto_cli_help() {
  # TODO reimplement
  cat <<EOF

Options:
  -h, --help      Print this help and exit

Setup commands:
  restore     Update local db with the latest dump from GCP
  reindex     Reindex Elasticsearch
  privileges  Elevate your user account privileges.
              Returns you the code to paste into datagrip
  pw          Password for connecting to db in DataGrip
EOF

  print_help_h2 Examples
  print_help_ex "comoto_cli db restore"
  print_help_ex "comoto_cli db reindex"
  print_help_ex "comoto_cli db privileges   # generates SQL code you can paste into datagrip"
  echo
}


# TODO `local command` instead?
commands=""

# TODO move this dir into comoto_cli
dumps_dir="$COMOTO_PROJECT_ROOT/.db-dumps"

_comoto_cli_db_actions=()

_comoto_cli_db_parse_args() {
  if [[ $# -eq 1 && $1 =~ ^(restore|reindex)$ ]] ; then
    _comoto_cli_db_actions+=("$1")
    return 0
  fi
}

_comoto_cli_add_user_accounts() {
  local email_address='jonathan.chukinas@revzilla.com'
  if ! print_confirm "Is this your account address: $email_address?" ; then
    echo exiting >&2
    return 1
  fi
  if ! print_confirm "You must have created used accounts before executing. Have you?" ; then
    echo exiting >&2
    return 1
  fi
  echo
  echo "-- Make yourself an admin"
  echo "UPDATE users SET role_id = 2 WHERE email_address = '$email_address';"
  for site_id in 1 4 16
  do
    echo
    echo "-- give yourself permissions for site $site_id"
    echo "INSERT INTO user_permission_sections (user_id, permission_section_id, site_id)"
    echo "  SELECT (SELECT id FROM users WHERE email_address = '$email_address' and site_id = $site_id), ps.id, $site_id"
    echo "  FROM permission_sections ps;"
  done
  echo
}

_comoto_cli_command_completion() {
  local cur_word="${COMP_WORDS[$COMP_CWORD]}"
  COMPREPLY=( $(compgen -W "privileges restore reindex pw" -- "$cur_word"))
}

_comoto_cli_execute() {

  while :; do
    case "${1-}" in
      -h|--help) $COMOTO_CLI_LIB/render_help; return 0;;
      *) break ;;
    esac
    shift
  done

  if [[ $# -eq 1 ]] ; then
    case $1 in
      privileges)
        _comoto_cli_add_user_accounts
        return 0
        ;;
      pw)
        echo
        echo "copy and paste this password into datagrip:"
        echo
        gcloud auth print-access-token
        echo
        return 0
        ;;
    esac
  fi

  _comoto_cli_db_parse_args "$*"

  for action in "${_comoto_cli_db_actions[@]}"
  do
    echo $action
    case $action in
      restore)  $COMOTO_CLI_LIB/db_restore_from_latest_dump ;;
      reindex)  $COMOTO_CLI_LIB/elasticsearch ;;
    esac
  done
  print_and_eval_command $commands
}
