#!/bin/bash

# TODO put underscrore in front of name
usage() {
  echo 'Usage: comoto_cli vc [OPTIONS] SUBCOMMAND FILTER_STRING'
}

_comoto_cli_command_usage() {
  echo
  usage
  cat <<EOF

Version Control helpers (git and gh wrappers)

Requires that the github CLI ('gh') be installed!

The filter string is used to find a PR number.
Then the corresponding gh command is called.
It assumes the repo is the monorepo.

Options:
  -h, --help  Print this help and exit

Subcommands:
  view
  checkout
  new

Examples:
  comoto_cli vc checkout 'footer'   # Executes: 'gh pr checkout 1234'
  comoto_cli vc checkout 'JPR-123'

  # Create and check out new branch 'JPR-123-my-short-description':
  comoto_cli vc new jpr 123 my short   description

EOF
}

# TODO put underscrore in front of name
error() {
  usage >&2
  return 1
}

# TODO move these to lib?
_vc_new_branch_text() {
  local project_prefix="$(echo "$1" | tr '[:lower:]' '[:upper:]')"
  shift
  local issue_number="$1"
  shift
  local short_description="$(echo "$*" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')"
  echo "$project_prefix-$issue_number-$short_description"
}

_vc_new_branch() {
  local branch_name=$(_vc_new_branch_text $*)
  . $COMOTO_CLI_ROOT/lib/print
  # TODO this is printing something weird
  if print_confirm "Create new branch? '$branch_name'" ; then
    git checkout -b $branch_name
    git push --set-upstream origin $branch_name
  fi
}

_comoto_cli_command_execute() {
  # TODO make sure all commands handle --help
  if [[ $1 =~ -h ]] ; then
    _comoto_cli_command_usage
    return 0
  fi

  . $COMOTO_CLI_ROOT/lib/print

  subcommand="$1"
  shift

  # TODO get rid of that nvim setting that doesn't un-visualize after indenting

  # TODO add help that says that the filter string can include either the pr or jira number
  # TODO add an echo that warns the user that they're not in the right dir (if that's the case)
  case $subcommand in
    checkout|view)
      if [[ $1 =~ ^(-h|--help)$ ]] ; then
        _comoto_cli_command_usage
        return 0
      fi
      filter_string="$1"
      echo filter string: $filter_string
      if [[ $# -eq 1 && -n $filter_string ]]
      then
        comoto_cli cd monorepo
        # TODO handle better for when multiple results come back
        pr_number="$(gh pr list | grep $filter_string | cut -f1)"
        echo PR number: $pr_number
        gh pr $subcommand $pr_number
      else
        error
      fi
      ;;
    new)
      _vc_new_branch $*
      ;;
    *)
      error
      ;;
  esac

}

_comoto_cli_command_completion() {
  local valid_args="checkout view"
  [[ $# -gt 1 ]] && return 1
  COMPREPLY=( $(compgen -W "$valid_args" -- "$1") )
  # TODO add completion for the subcommands
}
